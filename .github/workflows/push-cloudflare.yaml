name: Build

on:
    push:
        branches: [main, uat, release*]
    pull_request_target:
        branches: [main, uat, release*]
    workflow_dispatch:

jobs:
    build:
        name: Run production build
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            # selecting a toolchain either by action or manual `rustup` calls should happen
            # before the plugin, as the cache uses the current rustc version as its cache key
            - run: rustup toolchain install stable --profile minimal
            # - name: Cache Cargo registry and build artifacts
            #   uses: actions/cache@v3
            #   with:
            #       path: |
            #           target
            #           ~/.cargo/bin
            #           ~/.cargo/registry
            #           ~/.cargo/git
            #       key: cargo-build-cache-${{ github.run_id }}
            #       restore-keys: |
            #           cargo-build-cache-
            - run: rustup target add wasm32-unknown-unknown
            - name: Install lld
              run: sudo apt install -y lld clang gcc llvm

            - name: Install worker-build
              run: |
                  if ! command -v worker-build &> /dev/null; then
                    cargo install worker-build
                  fi

            # - name: Replace D1_DATABASE_ID in wrangler.toml
            #   run: sed -i "s/\${D1_DATABASE_ID}/${{ secrets.D1_DATABASE_ID }}/g" wrangler.toml

            - name: Create D1 Database and Capture ID
              id: create_d1
              run: |
                response=$(curl -s -w "\n%{http_code}" -X POST "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/d1/database" \
                  -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
                  -H "Content-Type: application/json" \
                  --data '{
                    "name": "warden-worker",
                    "location": "apac"
                  }')

                http_code=$(echo "$response" | tail -n1)
                body=$(echo "$response" | sed '$d')

                if [ "$http_code" -ne 200 ]; then
                  echo "::error::Failed to create D1 database. HTTP status: $http_code"
                  echo "Response body: $body"
                  exit 1
                fi

                db_id=$(echo "$body" | jq -r '.result.uuid')
                if [ -z "$db_id" ] || [ "$db_id" == "null" ]; then
                  echo "::error::Failed to extract D1 database ID from response."
                  echo "Response body: $body"
                  exit 1
                fi

                echo "D1_DATABASE_ID=$db_id" >> $GITHUB_ENV
                echo "Successfully created D1 database with ID: $db_id"

            - name: Replace D1_DATABASE_ID in wrangler.toml
              run: |
                if [ -z "${{ env.D1_DATABASE_ID }}" ]; then
                  echo "::error::D1_DATABASE_ID is not set."
                  exit 1
                fi
                sed -i "s/\${D1_DATABASE_ID}/${{ env.D1_DATABASE_ID }}/g" wrangler.toml
                echo "Successfully replaced D1_DATABASE_ID in wrangler.toml."

            - name: Apply D1 Database Schema
              run: |
                sql_content=$(cat sql/schema.sql)
                response=$(curl -s -w "\n%{http_code}" -X POST "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/d1/database/${{ env.D1_DATABASE_ID }}/query" \
                  -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
                  -H "Content-Type: application/json" \
                  --data-raw "{\"sql\": \"$sql_content\"}")

                http_code=$(echo "$response" | tail -n1)
                body=$(echo "$response" | sed '$d')

                if [ "$http_code" -ne 200 ]; then
                  echo "::error::Failed to apply D1 database schema. HTTP status: $http_code"
                  echo "Response body: $body"
                  exit 1
                fi

                echo "Successfully applied D1 database schema."

            - name: Create JWT_SECRET
              run: |
                secret_value=$(openssl rand -base64 48 | tr -d '\n')
                response=$(curl -s -w "\n%{http_code}" -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/workers/scripts/warden-worker/secrets" \
                  -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
                  -H "Content-Type: application/json" \
                  --data-raw "{\"name\": \"JWT_SECRET\", \"text\": \"$secret_value\"}")

                http_code=$(echo "$response" | tail -n1)
                body=$(echo "$response" | sed '$d')

                if [ "$http_code" -ne 200 ]; then
                  echo "::error::Failed to create JWT_SECRET. HTTP status: $http_code"
                  echo "Response body: $body"
                  exit 1
                fi

                echo "Successfully created JWT_SECRET."

            - name: Create JWT_REFRESH_SECRET
              run: |
                secret_value=$(openssl rand -base64 48 | tr -d '\n')
                response=$(curl -s -w "\n%{http_code}" -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/workers/scripts/warden-worker/secrets" \
                  -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
                  -H "Content-Type: application/json" \
                  --data-raw "{\"name\": \"JWT_REFRESH_SECRET\", \"text\": \"$secret_value\"}")

                http_code=$(echo "$response" | tail -n1)
                body=$(echo "$response" | sed '$d')

                if [ "$http_code" -ne 200 ]; then
                  echo "::error::Failed to create JWT_REFRESH_SECRET. HTTP status: $http_code"
                  echo "Response body: $body"
                  exit 1
                fi

                echo "Successfully created JWT_REFRESH_SECRET."

            - uses: cloudflare/wrangler-action@v3
              id: cf
              with:
                  secrets: |
                      ALLOWED_EMAILS
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
              env:
                  ALLOWED_EMAILS: ${{ secrets.ALLOWED_EMAILS }}
